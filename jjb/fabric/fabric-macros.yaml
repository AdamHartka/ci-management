- property:
    name: 'fabric-x86_64'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/opt/go/go1.6.linux.amd64
                PATH=/opt/go/go1.6.linux.amd64/bin:$GOPATH/bin:$PATH
                ARCH='x86_64'

- property:
    name: 'fabric-z'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/opt/go/
                PATH=/opt/go/bin:$GOPATH/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
                ARCH='s390x'

- parameter:
    name: github-pr-sha1
    parameters:
        - string:
            name: github_sha
            default: '${ghprbActualCommit}'
            description: "SHA1 commit id of Github pull request (eg: origin/pr/9/head)"


- scm:
    name: hyperledger-fabric
    scm:
        - git:
            url: 'https://github.com/hyperledger/fabric.git'
            branches:
               - 'origin/${branch}'
            skip-tag: true
            wipe-workspace: true
            basedir: 'gopath/src/github.com/hyperledger/fabric'

- scm:
    name: hyperledger-fabric-ghpr
    scm:
        - git:
            url: 'https://github.com/hyperledger/fabric.git'
            refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
            branches:
               - '${github_sha}'
            skip-tag: true
            wipe-workspace: true
            basedir: 'gopath/src/github.com/hyperledger/fabric'

- builder:
    name: output-environment
    builders:
      - shell: |
          #!/bin/bash -exu
          set -o pipefail

          # Output all information about the environment
          uname -a
          cat /etc/*-release
          env
          go version
          gcc --version
          docker version
          docker info
          pgrep -a docker

- builder:
    name: clean-environment
    builders:
      - shell:
          !include-raw-escape: include-raw-fabric-clean-environment.sh

- builder:
    name: fabric-docker-deploy
    builders:
      - shell:
          !include-raw-escape: include-raw-docker-image-deploy.sh

- builder:
    name: fabric-behave-tests
    builders:
      - shell:
          !include-raw-escape: include-raw-fabric-behave.sh

- builder:
    name: fabric-unit-tests
    builders:
        - shell: |
            #!/bin/bash -eu
            set -o pipefail


            cd gopath/src/github.com/hyperledger/fabric && make unit-test

- trigger:
    name: github-pr-builder
    triggers:
        - github-pull-request:
            org-list:
              - hyperledger
            trigger-phrase: 'reverify jenkins'
            only-trigger-phrase: false
            github-hooks: true
            permit-all: true
            auto-close-on-fail: false
            allow-whitelist-orgs-as-admins: false
            status-context: 'jenkins/{arch}'
            triggered-status: 'Build triggered'
            started-status: 'Build started'
            success-status: 'Build succeeded'
            failure-status: 'Build failed'
            error-status: 'Build errored'

- publisher:
    name: archive-behave-logs
    publishers:
        - archive:
            artifacts: 'gopath/src/github.com/hyperledger/fabric/bddtests/*.log'
            fingerprint: true
            default-excludes: false
            allow-empty: true
