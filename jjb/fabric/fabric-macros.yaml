- parameter:
    name: github-pr-sha1
    parameters:
        - string:
            name: sha1
            default: '${sha1}'
            description: "SHA1 commit id of Github pull request (eg: origin/pr/9/head)"

- scm:
    name: hyperledger-fabric-ghpr
    scm:
        - git:
            url: 'https://github.com/hyperledger/fabric.git'
            refspec: '+refs/pulls/*:refs/remotes/origin/pr/*'
            branches:
               - '${sha1}'
            skip-tag: true
            wipe-workspace: true
            basedir: 'gopath/src/github.com/hyperledger/fabric'

- builder:
    name: fabric-behave-tests
    builders:
      - shell:
          !include-raw-escape: include-raw-fabric-behave.sh

- builder:
    name: fabric-unit-tests
    builders:
        - shell: |
            #!/bin/bash -eu
            set -o pipefail

            export GOPATH="$WORKSPACE/gopath"
            export GOROOT="/opt/go/go1.6.linux.amd64"
            export PATH="/opt/go/go1.6.linux.amd64/bin:$GOPATH/bin:$PATH"

            cd gopath/src/github.com/hyperledger/fabric && make unit-test

- trigger:
    name: github-pr-builder
    triggers:
        - github-pull-request:
            org-list:
              - hyperledger
            trigger-phrase: 'reverify'
            only-trigger-phrase: false
            github-hooks: true
            permit-all: true
            auto-close-on-fail: false
            allow-whitelist-orgs-as-admins: false
            white-list-target-branches:
              - master
