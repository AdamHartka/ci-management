- property:
    name: 'fabric-x86_64'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/opt/go/go1.7.linux.amd64
                PATH=/opt/go/go1.7.linux.amd64/bin:$GOPATH/bin:~/npm/bin:$PATH
                ARCH=x86_64

- property:
    name: 'fabric-oldgo-x86_64'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/opt/go/go1.6.linux.amd64
                PATH=/opt/go/go1.6.linux.amd64/bin:$GOPATH/bin:~/npm/bin:$PATH
                ARCH=x86_64

- property:
    name: 'fabric-z'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/opt/go/
                PATH=/opt/go/bin:$GOPATH/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
                ARCH=s390x


- property:
    name: 'fabric-ppc64le'
    properties:
        - inject:
            properties-content: |
                GOPATH=$WORKSPACE/gopath
                GOROOT=/usr/local/go/
                PATH=$GOROOT/bin:$GOPATH/bin:$PATH
                ARCH=ppc64le


- scm:
    name: hyperledger-fabric-gerrit
    scm:
        - git:
            url: 'ssh://hyperledger-jobbuilder@gerrit.hyperledger.org:29418/fabric'
            branches:
               - 'origin/$GERRIT_BRANCH'
            wipe-workspace: true
            basedir: 'gopath/src/github.com/hyperledger/fabric'
            credentials-id: '{credentials-id}'
            refspec: '$GERRIT_REFSPEC'
            choosing-strategy: 'gerrit'

- builder:
    name: output-environment
    builders:
      - shell: |
          #!/bin/bash -exu
          set -o pipefail

          # Output all information about the environment
          uname -a
          cat /etc/*-release
          env
          go version
          gcc --version
          docker version
          docker info
          docker-compose version
          pgrep -a docker
          docker images
          docker ps -a

- builder:
    name: clean-environment
    builders:
      - shell:
          !include-raw: include-raw-fabric-clean-environment.sh

- builder:
    name: fabric-x86_64-docker-deploy
    builders:
      - shell:
          !include-raw: include-raw-x86_64-docker-image-deploy.sh

- builder:
    name: fabric-s390x-docker-deploy
    builders:
      - shell:
          !include-raw: include-raw-s390x-docker-image-deploy.sh

- builder:
    name: fabric-ppc64le-docker-deploy
    builders:
      - shell:
          !include-raw: include-raw-ppc64le-docker-image-deploy.sh

- builder:
    name: fabric-behave-tests
    builders:
      - shell:
          !include-raw: include-raw-fabric-behave.sh

- builder:
    name: fabric-unit-tests
    builders:
        - shell: |
            #!/bin/bash -eu
            set -o pipefail


            cd gopath/src/github.com/hyperledger/fabric && make linter && make membersrvc-image && make unit-test

- builder:
    name: fabric-node-sdk-unit-tests
    builders:
        - shell: |
            #!/bin/bash -exu
            set -o pipefail
            cd gopath/src/github.com/hyperledger/fabric && make node-sdk-unit-tests

- publisher:
    name: archive-behave-logs
    publishers:
        - archive:
            artifacts: 'gopath/src/github.com/hyperledger/fabric/bddtests/*.log'
            fingerprint: true
            default-excludes: false
            allow-empty: true

- publisher:
    name: code-coverage-report
    publishers:
        - cobertura:
            report-file: "**/report.xml"
            targets:
              - files:
                  healthy: 80
                  unhealthy: 50
                  failing: 0
              - method:
                  healthy: 80
                  unhealthy: 50
                  failing: 0
              - line:
                  healthy: 80
                  unhealthy: 50
                  failing: 0
              - packages:
                  healthy: 80
                  unhealthy: 50
                  failing: 0
              - classes:
                  healthy: 80
                  unhealthy: 50
                  failing: 0

- publisher:
    name: cop-code-coverage-report
    publishers:
        - cobertura:
            report-file: "**/coverage.xml"
            targets:
              - files:
                  healthy: 80
                  unhealthy: 75
                  failing: 0
              - method:
                  healthy: 80
                  unhealthy: 75
                  failing: 0
              - line:
                  healthy: 80
                  unhealthy: 75
                  failing: 0
              - packages:
                  healthy: 80
                  unhealthy: 75
                  failing: 0
              - classes:
                  healthy: 80
                  unhealthy: 75
                  failing: 0

- publisher:
    name: behave-test-results
    publishers:
        - junit:
            results: 'gopath/src/github.com/hyperledger/fabric/bddtests/reports/*.xml'

